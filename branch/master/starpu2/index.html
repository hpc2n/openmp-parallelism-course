<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StarPU runtime system (part 2) &mdash; OpenMP parallelism in scientific computing  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            OpenMP parallelism in scientific computing
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Day 1</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hpc2n-intro/">Introduction to HPC2N</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Introduction to Kebnekaise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiling-analysis/">Profiling analysis with VTune and Advisor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiling-analysis/#summary">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-steps/">First Steps in OpenMP</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data-handling/">Data for Parallel Regions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../worksharing/">Worksharing and Scheduling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data-handlingii/">More on Private Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../worksharingii/">More on Worksharing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 4</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tasks/">The Task Directive</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellanous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">OpenMP parallelism in scientific computing</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">StarPU runtime system (part 2)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/hpc2n/OpenMP-parallelism-course/blob/master/docs/starpu2.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="starpu-runtime-system-part-2">
<h1>StarPU runtime system (part 2)<a class="headerlink" href="#starpu-runtime-system-part-2" title="Permalink to this heading"></a></h1>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Understand more about StarPU</p></li>
<li><p>Understand how StarPU supports distributed memory</p></li>
<li><p>Understand how StarPU supports GPUs</p></li>
</ul>
</div>
<section id="data-handles-and-interfaces">
<h2>Data handles and interfaces<a class="headerlink" href="#data-handles-and-interfaces" title="Permalink to this heading"></a></h2>
<p>A task implementation <strong>should not modify the task arguments</strong> as these changes are not propagated to the other tasks.
Furthermore, the task arguments do not induce any task dependencies.
They are therefore only suitable for passing static arguments to the tasks.</p>
<p><strong>Data handles</strong> are much more flexible as any modification made in one task are passed to the other tasks and these changes also induce task dependencies.
A data handle (<cite>starpu_data_handle_t</cite>) can encapsulate any conceivable data type.
However, the built-in data interfaces for scalars, vectors and matrices are adequate for many use cases:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">starpu_variable_data_register</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_data_handle_t</span><span class="w"> </span><span class="o">*</span><span class="n">handle</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">home_node</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span>
<span class="p">)</span>

<span class="cp">#define STARPU_VARIABLE_GET_PTR (interface)</span>
<span class="cp">#define STARPU_VARIABLE_GET_ELEMSIZE (interface)</span>
</pre></div>
</div>
<p>Above, <cite>home_node</cite> is the <strong>memory node</strong> where the variable is initially stored.
In most cases, the variable is initially stored in the main memory (<cite>STARPU_MAIN_RAM</cite>).
The argument <cite>ptr</cite> is a pointer to the variable (in the main memory) and the argument <cite>size</cite> is the size of the variable.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">starpu_vector_data_register</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_data_handle_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">home_node</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nx</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">elemsize</span>
<span class="p">)</span>

<span class="cp">#define STARPU_VECTOR_GET_PTR (interface)</span>
<span class="cp">#define STARPU_VECTOR_GET_NX (interface)</span>
<span class="cp">#define STARPU_VECTOR_GET_ELEMSIZE (interface)</span>
</pre></div>
</div>
<p>Above, the argument <cite>nx</cite> is the length of the vector and the argument <cite>elemsize</cite> is the size of a vector element.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">starpu_matrix_data_register</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_data_handle_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">home_node</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ld</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nx</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ny</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">elemsize</span>
<span class="p">)</span>

<span class="cp">#define STARPU_MATRIX_GET_PTR (interface)</span>
<span class="cp">#define STARPU_MATRIX_GET_NX (interface)</span>
<span class="cp">#define STARPU_MATRIX_GET_NY (interface)</span>
<span class="cp">#define STARPU_MATRIX_GET_LD (interface)</span>
<span class="cp">#define STARPU_MATRIX_GET_ELEMSIZE (interface)</span>
</pre></div>
</div>
<p>Above, the argument <cite>ld</cite> is the leading dimension of the matrix (row-major order), the argument <cite>xn</cite> is the width of the matrix and the argument <cite>ny</cite> is the height of the matrix.</p>
<p>For example, the following example allocates a matrix and <strong>initializes</strong> a data handle that encapsulates the matrix:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ld</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="hll"><span class="linenos">2</span><span class="n">starpu_data_handle_t</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">3</span><span class="n">starpu_matrix_data_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_MAIN_RAM</span><span class="p">,</span>
</span><span class="hll"><span class="linenos">4</span><span class="w">    </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">matrix</span><span class="p">,</span><span class="w"> </span><span class="n">ld</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
</span></pre></div>
</div>
<figure class="align-default" id="id1">
<img alt="../_images/starpu_handles1.png" src="../_images/starpu_handles1.png" />
<figcaption>
<p><span class="caption-text">Data handles.</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The above example assumes that the matrix is stored in column-major order.</p>
<p>Each data handle must be <strong>unregistered</strong> before the main thread can access it again:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">starpu_data_unregister</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
</pre></div>
</div>
<p>This blocks the main thread until all related tasks have been executed.</p>
<p>The easiest way to pass a data handle to a task is to declare it in the related codelet:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span>
<span class="linenos"> 2</span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">where</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">can_execute</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">workerid</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_task</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">nimpl</span><span class="p">);</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_codelet_type</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">max_parallelism</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">starpu_cpu_func_t</span><span class="w"> </span><span class="n">cpu_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">starpu_cuda_func_t</span><span class="w"> </span><span class="n">cuda_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">starpu_opencl_func_t</span><span class="w"> </span><span class="n">opencl_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">starpu_cpu_func_t</span><span class="w"> </span><span class="n">cpu_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">11</span><span class="w">    </span><span class="n">starpu_cuda_func_t</span><span class="w"> </span><span class="n">cuda_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">12</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">cuda_flags</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">starpu_opencl_func_t</span><span class="w"> </span><span class="n">opencl_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">opencl_flags</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">starpu_mic_func_t</span><span class="w"> </span><span class="n">mic_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">starpu_mpi_ms_func_t</span><span class="w"> </span><span class="n">mpi_ms_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">17</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_funcs_name</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nbuffers</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_data_access_mode</span><span class="w"> </span><span class="n">modes</span><span class="p">[</span><span class="n">STARPU_NMAXBUFS</span><span class="p">];</span>
</span><span class="linenos">20</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_data_access_mode</span><span class="w"> </span><span class="o">*</span><span class="n">dyn_modes</span><span class="p">;</span>
<span class="linenos">21</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">specific_nodes</span><span class="p">;</span>
<span class="linenos">22</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">STARPU_NMAXBUFS</span><span class="p">];</span>
<span class="linenos">23</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dyn_nodes</span><span class="p">;</span>
<span class="linenos">24</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="o">*</span><span class="n">model</span><span class="p">;</span>
<span class="linenos">25</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="o">*</span><span class="n">energy_model</span><span class="p">;</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">per_worker_stats</span><span class="p">[</span><span class="n">STARPU_NMAXWORKERS</span><span class="p">];</span>
<span class="linenos">27</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="linenos">28</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">color</span><span class="p">;</span>
<span class="linenos">29</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="linenos">30</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">checked</span><span class="p">;</span>
<span class="linenos">31</span><span class="p">};</span>
</pre></div>
</div>
<p>The <cite>nbuffers</cite> field stores the total number of data handles the task accepts and the <cite>modes</cite> field tabulates an access mode for each data handle.
The access mode can be one of the following:</p>
<dl class="field-list simple">
<dt class="field-odd">STARPU_NONE<span class="colon">:</span></dt>
<dd class="field-odd"><p>Not documented.</p>
</dd>
<dt class="field-even">STARPU_R<span class="colon">:</span></dt>
<dd class="field-even"><p>Read-only mode.</p>
</dd>
<dt class="field-odd">STARPU_W<span class="colon">:</span></dt>
<dd class="field-odd"><p>Write-only mode.</p>
</dd>
<dt class="field-even">STARPU_RW<span class="colon">:</span></dt>
<dd class="field-even"><p>Read-write mode. Equivalent to <cite>STARPU_R | STARPU_W</cite>.</p>
</dd>
<dt class="field-odd">STARPU_SCRATCH<span class="colon">:</span></dt>
<dd class="field-odd"><p>Scratch buffer (one per device).</p>
</dd>
<dt class="field-even">STARPU_REDUX<span class="colon">:</span></dt>
<dd class="field-even"><p>The data handle is used in a reduction-type operation.</p>
</dd>
<dt class="field-odd">STARPU_COMMUTE<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tasks can access this variable in an arbitrary order.</p>
</dd>
<dt class="field-even">STARPU_SSEND<span class="colon">:</span></dt>
<dd class="field-even"><p>The data has to be sent using a synchronous and non-blocking mode (StarPU-MPI).</p>
</dd>
<dt class="field-odd">STARPU_LOCALITY<span class="colon">:</span></dt>
<dd class="field-odd"><p>Tells the scheduler that the data handle is sensitive to data locality.</p>
</dd>
<dt class="field-even">STARPU_ACCESS_MODE_MAX<span class="colon">:</span></dt>
<dd class="field-even"><p>Not documented.</p>
</dd>
</dl>
<p>Note that this limits the number of data handles passed to a task to <cite>STARPU_NMAXBUFS</cite>.
Furthermore, all tasks of a particular type must accept the <strong>same number of data handles</strong>.
The number of data handles passed to a codelet can be arbitrary but this feature is not covered during this course.</p>
<p>For example, the following example defines a codelet that accepts a single read-write data handle:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span><span class="w"> </span><span class="n">codelet</span><span class="w"> </span><span class="o">=</span>
<span class="linenos">2</span><span class="p">{</span>
<span class="linenos">3</span><span class="w">    </span><span class="p">.</span><span class="n">cpu_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="p">},</span>
<span class="hll"><span class="linenos">4</span><span class="w">    </span><span class="p">.</span><span class="n">nbuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll"><span class="linenos">5</span><span class="w">    </span><span class="p">.</span><span class="n">modes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">STARPU_RW</span><span class="w"> </span><span class="p">}</span>
</span><span class="linenos">6</span><span class="p">};</span>
</pre></div>
</div>
<p>The data handles are passed to the <cite>starpu_task_insert</cite> function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">starpu_task_insert</span><span class="p">(</span>
<span class="linenos">2</span><span class="w">    </span><span class="o">&amp;</span><span class="n">codelet</span><span class="p">,</span>
<span class="hll"><span class="linenos">3</span><span class="w">    </span><span class="n">STARPU_RW</span><span class="p">,</span>
</span><span class="hll"><span class="linenos">4</span><span class="w">    </span><span class="n">handle</span><span class="p">,</span>
</span><span class="linenos">5</span><span class="w">    </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, the task implementation extracts a matching <strong>data interface</strong> from the implementation arguments:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kt">void</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="linenos"> 2</span><span class="p">{</span>
<span class="hll"><span class="linenos"> 3</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_matrix_interface</span><span class="w"> </span><span class="o">*</span><span class="n">interface</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="linenos"> 4</span><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_matrix_interface</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class="linenos"> 5</span>
<span class="hll"><span class="linenos"> 6</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_MATRIX_GET_PTR</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
</span><span class="hll"><span class="linenos"> 7</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STARPU_MATRIX_GET_NX</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STARPU_MATRIX_GET_NY</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
</span><span class="hll"><span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STARPU_MATRIX_GET_LD</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
</span><span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="n">process</span><span class="p">(</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">ld</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">);</span>
<span class="linenos">12</span><span class="p">}</span>
</pre></div>
</div>
<figure class="align-default" id="id2">
<img alt="../_images/starpu_handles2.png" src="../_images/starpu_handles2.png" />
<figcaption>
<p><span class="caption-text">Data interfaces. The pointers <cite>matrix</cite> and <cite>ptr</cite> do not necessarily point to the same memory location.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The runtime system guarantees that <strong>data resides in the device memory</strong> when a worker thread starts executing the task.
If necessary, StarPU copies the data from one memory space to another.
The scalar and vector data handles have their own interfaces: <cite>starpu_variable_interface</cite> and <cite>starpu_vector_interface</cite>.</p>
<p>If two tasks are given the same data handle in their argument lists, then an <strong>implicit data dependency</strong> may be induced between the tasks:</p>
<figure class="align-default" id="id3">
<img alt="../_images/starpu_depedencies.png" src="../_images/starpu_depedencies.png" />
<figcaption>
<p><span class="caption-text">Two examples of data dependencies</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<div class="admonition-exercise exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise</p>
<p>Modify the example below as follows:</p>
<blockquote>
<div><ol class="arabic">
<li><p>Write a new task implementation (<cite>add_cpu</cite>) that</p>
<blockquote>
<div><ul class="simple">
<li><p>accepts three data handles (variable / <cite>int</cite>) as arguments (<cite>buffers[0]</cite>, <cite>buffers[1]</cite> and <cite>buffers[2]</cite>),</p></li>
<li><p>extracts the data interfaces from <cite>buffers</cite>: <cite>a_i</cite>, <cite>b_i</cite> and <cite>c_i</cite></p></li>
<li><p>adds up the first two arguments and stores the result to the third argument.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Write the corresponding codelet (<cite>add_cl</cite>).</p>
<blockquote>
<div><ul class="simple">
<li><p>Remember, the first two data handles are <cite>STARPU_R</cite> and the third <cite>STARPU_W</cite>.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Create three integer variables (<cite>int</cite>): <cite>a</cite>, <cite>b</cite> and <cite>c</cite>. Initialize <cite>b</cite> to <cite>7</cite>.</p></li>
<li><p>Register a data handle for each variable: <cite>a_h</cite>, <cite>b_h</cite> and <cite>c_h</cite>.</p></li>
<li><p>Insert an <cite>init_cl</cite> task that initializes <cite>a_h</cite> to 10.</p></li>
<li><p>Insert an <cite>add_cl</cite> task and give <cite>a_h</cite>, <cite>b_h</cite> and <cite>c_h</cite> as arguments.</p></li>
<li><p>Unregister <cite>a_h</cite>, <cite>b_h</cite> and <cite>c_h</cite>.</p></li>
<li><p>Print the variables <cite>a</cite>, <cite>b</cite> and <cite>c</cite>.</p></li>
</ol>
</div></blockquote>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;starpu.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1">// a task implementation that initializes a variable to 10</span>
<span class="linenos"> 5</span><span class="kt">void</span><span class="w"> </span><span class="nf">init_cpu</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cl_arg</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="p">{</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="n">a_i</span><span class="w"> </span><span class="o">=</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_VARIABLE_GET_PTR</span><span class="p">(</span><span class="n">a_i</span><span class="p">);</span>
<span class="linenos">10</span><span class="w">    </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="linenos">11</span><span class="p">}</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="c1">// a task implementation that adds two numbers and return the sum</span>
<span class="linenos">14</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span><span class="w"> </span><span class="n">init_cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">15</span><span class="w">    </span><span class="p">.</span><span class="n">cpu_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">init_cpu</span><span class="w"> </span><span class="p">},</span>
<span class="linenos">16</span><span class="w">    </span><span class="p">.</span><span class="n">nbuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">17</span><span class="w">    </span><span class="p">.</span><span class="n">modes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">STARPU_W</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">18</span><span class="p">};</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="linenos">21</span><span class="p">{</span>
<span class="linenos">22</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">25</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to initialize Starpu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">    </span><span class="c1">// initialize all data handles</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">starpu_data_handle_t</span><span class="w"> </span><span class="n">a_h</span><span class="p">;</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">starpu_variable_data_register</span><span class="p">(</span>
<span class="linenos">30</span><span class="w">        </span><span class="o">&amp;</span><span class="n">a_h</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_MAIN_RAM</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">    </span><span class="c1">// insert tasks</span>
<span class="linenos">33</span><span class="w">    </span><span class="n">starpu_task_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cl</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_W</span><span class="p">,</span><span class="w"> </span><span class="n">a_h</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">    </span><span class="c1">// unregister all data handles</span>
<span class="linenos">36</span><span class="w">    </span><span class="n">starpu_data_unregister</span><span class="p">(</span><span class="n">a_h</span><span class="p">);</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">    </span><span class="n">starpu_shutdown</span><span class="p">();</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">43</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;starpu.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1">// a task implementation that initializes a variable to 10</span>
<span class="linenos"> 5</span><span class="kt">void</span><span class="w"> </span><span class="nf">init_cpu</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cl_arg</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="p">{</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="n">a_i</span><span class="w"> </span><span class="o">=</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_VARIABLE_GET_PTR</span><span class="p">(</span><span class="n">a_i</span><span class="p">);</span>
<span class="linenos">10</span><span class="w">    </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="linenos">11</span><span class="p">}</span>
<span class="linenos">12</span>
<span class="hll"><span class="linenos">13</span><span class="c1">// a task implementation that adds two numbers and returns the sum</span>
</span><span class="hll"><span class="linenos">14</span><span class="kt">void</span><span class="w"> </span><span class="nf">add_cpu</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cl_arg</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">15</span><span class="p">{</span>
</span><span class="hll"><span class="linenos">16</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="n">a_i</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="linenos">17</span><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_VARIABLE_GET_PTR</span><span class="p">(</span><span class="n">a_i</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">19</span>
</span><span class="hll"><span class="linenos">20</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="n">b_i</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="linenos">21</span><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class="hll"><span class="linenos">22</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_VARIABLE_GET_PTR</span><span class="p">(</span><span class="n">b_i</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">23</span>
</span><span class="hll"><span class="linenos">24</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="n">c_i</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="linenos">25</span><span class="w">        </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_variable_interface</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">buffers</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class="hll"><span class="linenos">26</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_VARIABLE_GET_PTR</span><span class="p">(</span><span class="n">c_i</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">27</span>
</span><span class="hll"><span class="linenos">28</span><span class="w">    </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">29</span><span class="p">}</span>
</span><span class="linenos">30</span>
<span class="linenos">31</span><span class="c1">// initialization codelet</span>
<span class="linenos">32</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span><span class="w"> </span><span class="n">init_cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">33</span><span class="w">    </span><span class="p">.</span><span class="n">cpu_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">init_cpu</span><span class="w"> </span><span class="p">},</span>
<span class="linenos">34</span><span class="w">    </span><span class="p">.</span><span class="n">nbuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">35</span><span class="w">    </span><span class="p">.</span><span class="n">modes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">STARPU_W</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">36</span><span class="p">};</span>
<span class="linenos">37</span>
<span class="hll"><span class="linenos">38</span><span class="c1">// addition codelet</span>
</span><span class="hll"><span class="linenos">39</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span><span class="w"> </span><span class="n">add_cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="linenos">40</span><span class="w">    </span><span class="p">.</span><span class="n">cpu_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">add_cpu</span><span class="w"> </span><span class="p">},</span>
</span><span class="hll"><span class="linenos">41</span><span class="w">    </span><span class="p">.</span><span class="n">nbuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
</span><span class="hll"><span class="linenos">42</span><span class="w">    </span><span class="p">.</span><span class="n">modes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">STARPU_R</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_R</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_W</span><span class="w"> </span><span class="p">}</span>
</span><span class="hll"><span class="linenos">43</span><span class="p">};</span>
</span><span class="linenos">44</span>
<span class="linenos">45</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="linenos">46</span><span class="p">{</span>
<span class="hll"><span class="linenos">47</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
</span><span class="linenos">48</span>
<span class="linenos">49</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">50</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to initialize Starpu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="w">    </span><span class="c1">// initialize all data handles</span>
<span class="hll"><span class="linenos">53</span><span class="w">    </span><span class="n">starpu_data_handle_t</span><span class="w"> </span><span class="n">a_h</span><span class="p">,</span><span class="w"> </span><span class="n">b_h</span><span class="p">,</span><span class="w"> </span><span class="n">c_h</span><span class="p">;</span>
</span><span class="linenos">54</span><span class="w">    </span><span class="n">starpu_variable_data_register</span><span class="p">(</span>
<span class="linenos">55</span><span class="w">        </span><span class="o">&amp;</span><span class="n">a_h</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_MAIN_RAM</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
<span class="hll"><span class="linenos">56</span><span class="w">    </span><span class="n">starpu_variable_data_register</span><span class="p">(</span>
</span><span class="hll"><span class="linenos">57</span><span class="w">        </span><span class="o">&amp;</span><span class="n">b_h</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_MAIN_RAM</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
</span><span class="hll"><span class="linenos">58</span><span class="w">    </span><span class="n">starpu_variable_data_register</span><span class="p">(</span>
</span><span class="hll"><span class="linenos">59</span><span class="w">        </span><span class="o">&amp;</span><span class="n">c_h</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_MAIN_RAM</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
</span><span class="linenos">60</span>
<span class="linenos">61</span><span class="w">    </span><span class="c1">// insert tasks</span>
<span class="linenos">62</span><span class="w">    </span><span class="n">starpu_task_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cl</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_W</span><span class="p">,</span><span class="w"> </span><span class="n">a_h</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="hll"><span class="linenos">63</span><span class="w">    </span><span class="n">starpu_task_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">add_cl</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_R</span><span class="p">,</span><span class="w"> </span><span class="n">a_h</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_R</span><span class="p">,</span><span class="w"> </span><span class="n">b_h</span><span class="p">,</span><span class="w"> </span><span class="n">STARPU_W</span><span class="p">,</span><span class="w"> </span><span class="n">c_h</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span class="linenos">64</span>
<span class="linenos">65</span><span class="w">    </span><span class="c1">// unregister all data handles</span>
<span class="linenos">66</span><span class="w">    </span><span class="n">starpu_data_unregister</span><span class="p">(</span><span class="n">a_h</span><span class="p">);</span>
<span class="hll"><span class="linenos">67</span><span class="w">    </span><span class="n">starpu_data_unregister</span><span class="p">(</span><span class="n">b_h</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">68</span><span class="w">    </span><span class="n">starpu_data_unregister</span><span class="p">(</span><span class="n">c_h</span><span class="p">);</span>
</span><span class="linenos">69</span>
<span class="hll"><span class="linenos">70</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d + %d = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span class="linenos">71</span>
<span class="linenos">72</span><span class="w">    </span><span class="n">starpu_shutdown</span><span class="p">();</span>
<span class="linenos">73</span>
<span class="linenos">74</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">75</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>starpu_program<span class="w"> </span>starpu_program.c<span class="w"> </span>-Wall<span class="w"> </span>-lstarpu-1.3
$<span class="w"> </span>./starpu_program
<span class="m">10</span><span class="w"> </span>+<span class="w"> </span><span class="nv">7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">17</span>
</pre></div>
</div>
</div>
</section>
<section id="distributed-memory">
<h2>Distributed memory<a class="headerlink" href="#distributed-memory" title="Permalink to this heading"></a></h2>
<p>StarPU supports distributed memory through MPI in three different ways:</p>
<blockquote>
<div><ol class="arabic">
<li><p>Without StarPU-MPI.</p>
<blockquote>
<div><ul class="simple">
<li><p>A programmer must manually transfer the data between StarPU data handles and MPI.</p></li>
<li><p>Not generally recommended but might be a good stopgap solution.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>With StarPU-MPI.</p>
<blockquote>
<div><ul class="simple">
<li><p>A programmer replaces the <code class="code docutils literal notranslate"><span class="pre">MPI_Recv()</span></code> and <code class="code docutils literal notranslate"><span class="pre">MPI_Send()</span></code> calls with <code class="code docutils literal notranslate"><span class="pre">starpu_mpi_irecv_detached()</span></code> and <code class="code docutils literal notranslate"><span class="pre">starpu_mpi_isend_detached()</span></code> calls.
These functions act directly on the StarPU data handles.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>With MPI Insert Task Utility.</p>
<blockquote>
<div><ul class="simple">
<li><p>A programmer replaces the <code class="code docutils literal notranslate"><span class="pre">starpu_task_insert()</span></code> calls with <code class="code docutils literal notranslate"><span class="pre">starpu_mpi_task_insert()</span></code> calls.
In addition, one must use the <code class="code docutils literal notranslate"><span class="pre">starpu_mpi_data_register()</span></code> function to tell which MPI process owns each data handle.</p></li>
</ul>
</div></blockquote>
</li>
</ol>
</div></blockquote>
<p>The second and third approach allocate one CPU core for MPI communications.
In the third approach, the <code class="code docutils literal notranslate"><span class="pre">starpu_mpi_task_insert()</span></code> function takes into account the task dependencies and the data distribution, and <strong>generates the necessary communication pattern automatically</strong>:</p>
<figure class="align-default">
<img alt="../_images/mpi.png" src="../_images/mpi.png" />
</figure>
<p>In the above illustration, each MPI process has a copy of the entire task graph.
Two things can happen:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>If the MPI process is going to execute a task, it can <strong>receive</strong> any missing data handle from the MPI process that owns the data handle.</p></li>
<li><p>If the MPI process is not going to execute a task, it will <strong>send</strong> any data handles it owns to the MPI process that is going to execute the task.</p></li>
</ol>
</div></blockquote>
<p>This all happens automatically and asynchronously.
The task implementations do not require any modifications!
StarPU-MPI also implements a MPI cache that caches data handles that were not modified.</p>
<p>Consider the following example where each MPI process writes its rank to a data handle and then passes it to the neighbouring MPI process:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;starpu.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;starpu_mpi.h&gt;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="c1">// a codelet that initializes a data handle with a MPI process&#39; world rank</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kt">void</span><span class="w"> </span><span class="nf">write_number_cpu</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cl_arg</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="p">{</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">world_rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">starpu_mpi_world_rank</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_VARIABLE_GET_PTR</span><span class="p">(</span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">world_rank</span><span class="p">;</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Rank %d writes value %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">world_rank</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">);</span>
<span class="linenos">14</span><span class="p">}</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span><span class="w"> </span><span class="n">write_number_cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">17</span><span class="w">    </span><span class="p">.</span><span class="n">cpu_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">write_number_cpu</span><span class="w"> </span><span class="p">},</span>
<span class="linenos">18</span><span class="w">    </span><span class="p">.</span><span class="n">nbuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">19</span><span class="w">    </span><span class="p">.</span><span class="n">modes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">STARPU_W</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">20</span><span class="p">};</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="c1">// a codelet that prints the contents of a data handle</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="kt">void</span><span class="w"> </span><span class="nf">read_number_cpu</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cl_arg</span><span class="p">)</span>
<span class="linenos">25</span><span class="p">{</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">world_rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">starpu_mpi_world_rank</span><span class="p">();</span>
<span class="linenos">27</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">STARPU_VARIABLE_GET_PTR</span><span class="p">(</span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<span class="linenos">28</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Rank %d reads value %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">world_rank</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="linenos">29</span><span class="p">}</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span><span class="w"> </span><span class="n">read_number_cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">32</span><span class="w">    </span><span class="p">.</span><span class="n">cpu_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">read_number_cpu</span><span class="w"> </span><span class="p">},</span>
<span class="linenos">33</span><span class="w">    </span><span class="p">.</span><span class="n">nbuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">34</span><span class="w">    </span><span class="p">.</span><span class="n">modes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">STARPU_R</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">35</span><span class="p">};</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="c1">// initialize MPI</span>
<span class="linenos">40</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">thread_support</span><span class="p">;</span>
<span class="linenos">41</span><span class="w">    </span><span class="n">MPI_Init_thread</span><span class="p">(</span>
<span class="linenos">42</span><span class="w">        </span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">***</span><span class="p">)</span><span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_THREAD_MULTIPLE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">thread_support</span><span class="p">);</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">    </span><span class="c1">// initialize StarPU</span>
<span class="linenos">45</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">46</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to initialize Starpu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">47</span>
<span class="hll"><span class="linenos">48</span><span class="w">    </span><span class="c1">// initialize StarPU-MPI</span>
</span><span class="hll"><span class="linenos">49</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_mpi_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">50</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to initialize Starpu-MPI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class="linenos">51</span>
<span class="linenos">52</span><span class="w">    </span><span class="c1">// query world communicator&#39;s size</span>
<span class="linenos">53</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">world_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">starpu_mpi_world_size</span><span class="p">();</span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="w">    </span><span class="c1">// initialize all data handles</span>
<span class="linenos">56</span><span class="w">    </span><span class="n">starpu_data_handle_t</span><span class="w"> </span><span class="n">handles</span><span class="p">[</span><span class="n">world_size</span><span class="p">];</span>
<span class="linenos">57</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">world_size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="w">        </span><span class="c1">// register a data handle that is going to be initialized later</span>
<span class="linenos">60</span><span class="w">        </span><span class="n">starpu_variable_data_register</span><span class="p">(</span>
<span class="linenos">61</span><span class="w">            </span><span class="o">&amp;</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="linenos">62</span>
<span class="hll"><span class="linenos">63</span><span class="w">        </span><span class="c1">// register data handle&#39;s owner and tag</span>
</span><span class="hll"><span class="linenos">64</span><span class="w">        </span><span class="n">starpu_mpi_data_register</span><span class="p">(</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span class="linenos">65</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">66</span>
<span class="linenos">67</span><span class="w">    </span><span class="c1">// insert tasks that initialize the data handles</span>
<span class="linenos">68</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">world_size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="hll"><span class="linenos">69</span><span class="w">        </span><span class="n">starpu_mpi_task_insert</span><span class="p">(</span>
</span><span class="hll"><span class="linenos">70</span><span class="w">            </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">write_number_cl</span><span class="p">,</span>
</span><span class="hll"><span class="linenos">71</span><span class="w">            </span><span class="n">STARPU_EXECUTE_ON_DATA</span><span class="p">,</span><span class="w"> </span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="c1">// data handles owner executes</span>
</span><span class="hll"><span class="linenos">72</span><span class="w">            </span><span class="n">STARPU_W</span><span class="p">,</span><span class="w"> </span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span class="linenos">73</span>
<span class="linenos">74</span><span class="w">    </span><span class="c1">// insert tasks that print the data handles</span>
<span class="linenos">75</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">world_size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="hll"><span class="linenos">76</span><span class="w">        </span><span class="n">starpu_mpi_task_insert</span><span class="p">(</span>
</span><span class="hll"><span class="linenos">77</span><span class="w">            </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">read_number_cl</span><span class="p">,</span>
</span><span class="hll"><span class="linenos">78</span><span class="w">            </span><span class="n">STARPU_EXECUTE_ON_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w">          </span><span class="c1">// rank i executes</span>
</span><span class="hll"><span class="linenos">79</span><span class="w">            </span><span class="n">STARPU_R</span><span class="p">,</span><span class="w"> </span><span class="n">handles</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">world_size</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span class="linenos">80</span>
<span class="linenos">81</span><span class="w">    </span><span class="c1">// unregister all data handles</span>
<span class="linenos">82</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">world_size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">83</span><span class="w">        </span><span class="n">starpu_data_unregister</span><span class="p">(</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">84</span>
<span class="linenos">85</span><span class="w">    </span><span class="c1">// de-initialize everything</span>
<span class="hll"><span class="linenos">86</span><span class="w">    </span><span class="n">starpu_mpi_shutdown</span><span class="p">();</span>
</span><span class="linenos">87</span><span class="w">    </span><span class="n">starpu_shutdown</span><span class="p">();</span>
<span class="linenos">88</span><span class="w">    </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="linenos">89</span>
<span class="linenos">90</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">91</span><span class="p">}</span>
</pre></div>
</div>
<p>We are going to launch four MPI processes and allocate two CPU cores for each process:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-lstarpu-1.3<span class="w"> </span>-lstarpumpi-1.3<span class="w"> </span>-lmpi<span class="w"> </span>-Wall
$<span class="w"> </span><span class="nv">STARPU_WORKERS_NOBIND</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>mpirun<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span>--map-by<span class="w"> </span>:PE<span class="o">=</span><span class="m">2</span><span class="w"> </span>./my_program
<span class="hll">Rank<span class="w"> </span><span class="m">1</span><span class="w"> </span>writes<span class="w"> </span>value<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>writes<span class="w"> </span>value<span class="w"> </span><span class="m">0</span>.
</span><span class="hll">Rank<span class="w"> </span><span class="m">2</span><span class="w"> </span>writes<span class="w"> </span>value<span class="w"> </span><span class="m">2</span>.
</span><span class="hll">Rank<span class="w"> </span><span class="m">3</span><span class="w"> </span>reads<span class="w"> </span>value<span class="w"> </span><span class="m">0</span>.
</span><span class="hll">Rank<span class="w"> </span><span class="m">3</span><span class="w"> </span>writes<span class="w"> </span>value<span class="w"> </span><span class="m">3</span>.
</span><span class="hll">Rank<span class="w"> </span><span class="m">0</span><span class="w"> </span>reads<span class="w"> </span>value<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">Rank<span class="w"> </span><span class="m">1</span><span class="w"> </span>reads<span class="w"> </span>value<span class="w"> </span><span class="m">2</span>.
</span><span class="hll">Rank<span class="w"> </span><span class="m">2</span><span class="w"> </span>reads<span class="w"> </span>value<span class="w"> </span><span class="m">3</span>.
</span></pre></div>
</div>
</section>
<section id="accelerators">
<h2>Accelerators<a class="headerlink" href="#accelerators" title="Permalink to this heading"></a></h2>
<p>As you may remember, a StarPU codelet included a field for CUDA implementations:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span>
<span class="linenos"> 2</span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">where</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">can_execute</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">workerid</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_task</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">nimpl</span><span class="p">);</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_codelet_type</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">max_parallelism</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">starpu_cpu_func_t</span><span class="w"> </span><span class="n">cpu_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">starpu_cuda_func_t</span><span class="w"> </span><span class="n">cuda_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">starpu_opencl_func_t</span><span class="w"> </span><span class="n">opencl_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">starpu_cpu_func_t</span><span class="w"> </span><span class="n">cpu_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">starpu_cuda_func_t</span><span class="w"> </span><span class="n">cuda_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
</span><span class="linenos">12</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">cuda_flags</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">starpu_opencl_func_t</span><span class="w"> </span><span class="n">opencl_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">opencl_flags</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">starpu_mic_func_t</span><span class="w"> </span><span class="n">mic_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">starpu_mpi_ms_func_t</span><span class="w"> </span><span class="n">mpi_ms_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">17</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_funcs_name</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">18</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nbuffers</span><span class="p">;</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_data_access_mode</span><span class="w"> </span><span class="n">modes</span><span class="p">[</span><span class="n">STARPU_NMAXBUFS</span><span class="p">];</span>
<span class="linenos">20</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_data_access_mode</span><span class="w"> </span><span class="o">*</span><span class="n">dyn_modes</span><span class="p">;</span>
<span class="linenos">21</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">specific_nodes</span><span class="p">;</span>
<span class="linenos">22</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">STARPU_NMAXBUFS</span><span class="p">];</span>
<span class="linenos">23</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dyn_nodes</span><span class="p">;</span>
<span class="linenos">24</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="o">*</span><span class="n">model</span><span class="p">;</span>
<span class="linenos">25</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="o">*</span><span class="n">energy_model</span><span class="p">;</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">per_worker_stats</span><span class="p">[</span><span class="n">STARPU_NMAXWORKERS</span><span class="p">];</span>
<span class="linenos">27</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="linenos">28</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">color</span><span class="p">;</span>
<span class="linenos">29</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="linenos">30</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">checked</span><span class="p">;</span>
<span class="linenos">31</span><span class="p">};</span>
</pre></div>
</div>
<p>Unfortunately we do not have time to cover all the complexities related to GPU offloading.
Instead, we will simply consider the following example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;starpu.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="w"> </span><span class="nf">hello_world_cpu</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cl_arg</span><span class="p">)</span>
<span class="linenos"> 5</span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The host says, Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos"> 7</span><span class="p">}</span>
<span class="linenos"> 8</span>
<span class="hll"><span class="linenos"> 9</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">say_hello</span><span class="p">()</span>
</span><span class="hll"><span class="linenos">10</span><span class="p">{</span>
</span><span class="hll"><span class="linenos">11</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;A device says, Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">12</span><span class="p">}</span>
</span><span class="linenos">13</span>
<span class="hll"><span class="linenos">14</span><span class="kt">void</span><span class="w"> </span><span class="n">hello_world_cuda</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffers</span><span class="p">[],</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">cl_arg</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">15</span><span class="p">{</span>
</span><span class="hll"><span class="linenos">16</span><span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">starpu_cuda_get_local_stream</span><span class="p">();</span>
</span><span class="hll"><span class="linenos">17</span><span class="w">    </span><span class="n">say_hello</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="o">&gt;&gt;&gt;</span><span class="p">();</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">    </span><span class="n">cudaError</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">19</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">20</span><span class="w">        </span><span class="n">STARPU_CUDA_REPORT_ERROR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span><span class="hll"><span class="linenos">21</span><span class="p">}</span>
</span><span class="linenos">22</span>
<span class="linenos">23</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span><span class="w"> </span><span class="n">hello_world_cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">24</span><span class="w">    </span><span class="p">.</span><span class="n">cpu_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">hello_world_cpu</span><span class="w"> </span><span class="p">},</span>
<span class="hll"><span class="linenos">25</span><span class="w">    </span><span class="p">.</span><span class="n">cuda_funcs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">hello_world_cuda</span><span class="w"> </span><span class="p">}</span>
</span><span class="linenos">26</span><span class="p">};</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="linenos">29</span><span class="p">{</span>
<span class="linenos">30</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">starpu_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">31</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to initialize Starpu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">    </span><span class="n">starpu_task_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hello_world_cl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">    </span><span class="n">starpu_task_wait_for_all</span><span class="p">();</span>
<span class="linenos">36</span><span class="w">    </span><span class="n">starpu_shutdown</span><span class="p">();</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">39</span><span class="p">}</span>
</pre></div>
</div>
<p>That is, we must add a task implementation (<code class="code docutils literal notranslate"><span class="pre">hello_world_cuda</span></code>) that inserts a CUDA kernel (<code class="code docutils literal notranslate"><span class="pre">say_hello</span></code>) to the provided local CUDA stream (<code class="code docutils literal notranslate"><span class="pre">stream</span></code>).
Note how the naive <code class="code docutils literal notranslate"><span class="pre">eager</span></code> scheduler prefers to use the CPU implementation where as the GPU-aware <code class="code docutils literal notranslate"><span class="pre">dm</span></code> scheduler prefers the GPU:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>nvcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.cu<span class="w"> </span>-lstarpu-1.3<span class="w"> </span>-Xcompiler<span class="o">=</span><span class="s2">&quot;-Wall&quot;</span>
$<span class="w"> </span><span class="nv">STARPU_SCHED</span><span class="o">=</span>eager<span class="w"> </span>./my_program
<span class="hll">The<span class="w"> </span>host<span class="w"> </span>says,<span class="w"> </span>Hello<span class="w"> </span>world!
</span>$<span class="w"> </span><span class="nv">STARPU_SCHED</span><span class="o">=</span>dm<span class="w"> </span>./my_program
<span class="hll">A<span class="w"> </span>device<span class="w"> </span>says,<span class="w"> </span>Hello<span class="w"> </span>world!
</span></pre></div>
</div>
<p>If we want to obtain a reasonable performance using GPUs, we must define a performance model for each codelet:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_codelet</span>
<span class="linenos"> 2</span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">where</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">can_execute</span><span class="p">)(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">workerid</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_task</span><span class="w"> </span><span class="o">*</span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">nimpl</span><span class="p">);</span>
<span class="linenos"> 5</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_codelet_type</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">max_parallelism</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">starpu_cpu_func_t</span><span class="w"> </span><span class="n">cpu_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">starpu_cuda_func_t</span><span class="w"> </span><span class="n">cuda_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="n">starpu_opencl_func_t</span><span class="w"> </span><span class="n">opencl_func</span><span class="w"> </span><span class="n">STARPU_DEPRECATED</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">starpu_cpu_func_t</span><span class="w"> </span><span class="n">cpu_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">11</span><span class="w">    </span><span class="n">starpu_cuda_func_t</span><span class="w"> </span><span class="n">cuda_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">12</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">cuda_flags</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">starpu_opencl_func_t</span><span class="w"> </span><span class="n">opencl_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">14</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">opencl_flags</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">starpu_mic_func_t</span><span class="w"> </span><span class="n">mic_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">starpu_mpi_ms_func_t</span><span class="w"> </span><span class="n">mpi_ms_funcs</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">17</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cpu_funcs_name</span><span class="p">[</span><span class="n">STARPU_MAXIMPLEMENTATIONS</span><span class="p">];</span>
<span class="linenos">18</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nbuffers</span><span class="p">;</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_data_access_mode</span><span class="w"> </span><span class="n">modes</span><span class="p">[</span><span class="n">STARPU_NMAXBUFS</span><span class="p">];</span>
<span class="linenos">20</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">starpu_data_access_mode</span><span class="w"> </span><span class="o">*</span><span class="n">dyn_modes</span><span class="p">;</span>
<span class="linenos">21</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">specific_nodes</span><span class="p">;</span>
<span class="linenos">22</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nodes</span><span class="p">[</span><span class="n">STARPU_NMAXBUFS</span><span class="p">];</span>
<span class="linenos">23</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dyn_nodes</span><span class="p">;</span>
<span class="hll"><span class="linenos">24</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="o">*</span><span class="n">model</span><span class="p">;</span>
</span><span class="linenos">25</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="o">*</span><span class="n">energy_model</span><span class="p">;</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">per_worker_stats</span><span class="p">[</span><span class="n">STARPU_NMAXWORKERS</span><span class="p">];</span>
<span class="linenos">27</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="linenos">28</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">color</span><span class="p">;</span>
<span class="linenos">29</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="linenos">30</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">checked</span><span class="p">;</span>
<span class="linenos">31</span><span class="p">};</span>
</pre></div>
</div>
<p>In the simplest case, the model can use the run time history to predict the execution times:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2</span><span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STARPU_HISTORY_BASED</span>
<span class="linenos">3</span><span class="p">};</span>
</pre></div>
</div>
<p>StarPU also supports regression based performance models (<code class="code docutils literal notranslate"><span class="pre">STARPU_REGRESSION_BASED</span></code>, <code class="code docutils literal notranslate"><span class="pre">STARPU_NL_REGRESSION_BASED</span></code>, <code class="code docutils literal notranslate"><span class="pre">STARPU_MULTIPLE_REGRESSION_BASED</span></code>):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">struct</span><span class="w"> </span><span class="nc">starpu_perfmodel</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2</span><span class="w">    </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STARPU_REGRESSION_BASED</span>
<span class="linenos">3</span><span class="p">};</span>
</pre></div>
</div>
<p>By default, StarPU calculates the model argument (base) from the amount of memory required to store all involved data handles.
However, a programmer may provide a custom function for this.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>